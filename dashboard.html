<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard v4 - Detector de Oportunidades</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #2180A0;
      --secondary: #1a2332;
      --text: #e8edef;
      --success: #32b898;
      --warning: #a84b2f;
      --error: #c01530;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--secondary); color: var(--text); overflow: hidden; }
    .container { display: flex; height: 100vh; gap: 12px; padding: 12px; }
    .panel-left { width: 280px; background: #243447; border-radius: 8px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .panel-header { padding: 16px; background: rgba(33, 128, 160, 0.15); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .panel-header h2 { font-size: 16px; margin-bottom: 4px; }
    .panel-header p { font-size: 11px; color: rgba(232, 237, 239, 0.6); }
    .menu-section { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-section h3 { font-size: 10px; text-transform: uppercase; color: rgba(232, 237, 239, 0.5); margin-bottom: 8px; letter-spacing: 0.5px; }
    .menu-item { padding: 12px; margin-bottom: 6px; background: rgba(255,255,255,0.05); border: 1px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .menu-item:hover { background: rgba(33, 128, 160, 0.2); border-color: var(--primary); }
    .menu-item.active { background: var(--primary); border-color: var(--primary); font-weight: 500; }
    .select-control { padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text); font-size: 13px; margin: 8px 0; width: 100%; }
    .select-control:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.08); }
    .panel-center { flex: 1; background: #243447; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .message { display: flex; gap: 8px; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { justify-content: flex-end; }
    .message.system { justify-content: flex-start; }
    .message-content { max-width: 75%; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
    .message.user .message-content { background: var(--primary); color: white; }
    .message.system .message-content { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); }
    .oportunidad { background: rgba(50, 184, 152, 0.1); border-left: 4px solid var(--success); padding: 12px; margin: 8px 0; border-radius: 6px; font-size: 13px; }
    .urgencia-alta { background: rgba(192, 21, 47, 0.15); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; }
    .urgencia-media { background: rgba(168, 75, 47, 0.15); color: var(--warning); padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; }
    .urgencia-baja { background: rgba(98, 108, 113, 0.15); color: #a0aec0; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; }
    .chat-input-area { padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px; }
    .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 10px 12px; color: var(--text); font-size: 14px; resize: none; max-height: 80px; }
    .chat-input:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.08); }
    .btn-send { padding: 10px 16px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 500; transition: 0.2s; }
    .btn-send:hover { background: #1a6a7f; }
    .btn-send:active { transform: scale(0.95); }
    .panel-right { width: 300px; background: #243447; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .panel-right-header { padding: 16px; background: rgba(50, 184, 198, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .panel-right-header h3 { font-size: 14px; margin-bottom: 4px; }
    .panel-right-body { flex: 1; overflow-y: auto; padding: 16px; }
    .metric-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; margin-bottom: 10px; }
    .metric-label { font-size: 11px; text-transform: uppercase; color: rgba(232, 237, 239, 0.6); margin-bottom: 4px; }
    .metric-value { font-size: 18px; font-weight: 600; }
    .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    #criteriaPanel { display: none; padding: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
    #criteriaPanel button { width: 100%; padding: 6px; margin-bottom: 4px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--text); cursor: pointer; font-size: 11px; transition: 0.2s; }
    #criteriaPanel button:hover { background: rgba(33, 128, 160, 0.2); }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel-left">
      <div class="panel-header">
        <h2>üìä Trading Dashboard</h2>
        <p>Detector de Oportunidades v4</p>
      </div>
      
      <div class="menu-section">
        <h3>Mercados</h3>
        <div class="menu-item active" onclick="selectMenu('europa', this)"><span>üåÖ</span> Europa</div>
        <div class="menu-item" onclick="selectMenu('usa', this)"><span>üåô</span> USA</div>
      </div>
      
      <div class="menu-section">
        <h3>Sectores</h3>
        <select class="select-control" id="sectorSelect" onchange="selectSector(this.value)">
          <option value="">Seleccionar sector...</option>
          <option value="tech">üíª Tecnolog√≠a</option>
          <option value="banks">üè¶ Banca</option>
          <option value="energy">‚ö° Energ√≠a</option>
          <option value="pharma">üíä Farmac√©utica</option>
          <option value="retail">üõí Retail</option>
          <option value="industrial">üè≠ Industrial</option>
        </select>
      </div>
      
      <div class="menu-section">
        <h3>Custom</h3>
        <input type="text" id="customStocks" class="select-control" placeholder="AAPL,MSFT,GOOGL" />
        <button onclick="analizarCustom()" style="width: 100%; padding: 8px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; margin-top: 4px;">üîç Buscar</button>
      </div>
      
      <div class="menu-section">
        <h3>üîç Scanner</h3>
        <button onclick="scannerRapido()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: linear-gradient(135deg, #2180A0, #1a6a7f); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 13px; font-weight: 600;">‚ö° Top 15</button>
        <button onclick="openScannerCriteria()" style="width: 100%; padding: 10px; background: rgba(50, 184, 152, 0.2); border: 1px solid var(--success); border-radius: 6px; color: var(--success); cursor: pointer; font-size: 13px; font-weight: 600;">üéØ Criterios</button>
      </div>
      
      <div id="criteriaPanel">
        <button onclick="scannerCriteria('rsi_oversold')">RSI Sobrevendido</button>
        <button onclick="scannerCriteria('high_volume')">Alto Volumen</button>
        <button onclick="scannerCriteria('reversal')">Reversiones</button>
        <button onclick="scannerCriteria('bullish_trend')">Tendencia Alcista</button>
        <button onclick="scannerCriteria('undervalued')">Subvalorados</button>
        <button onclick="scannerCriteria('momentum')">Momentum Fuerte</button>
      </div>
    </div>
    
    <div class="panel-center">
      <div class="chat-messages" id="chatMessages">
        <div class="message system">
          <div class="message-content">
            <strong>ü§ñ Trading Dashboard v4</strong><br><br>
            ‚úÖ An√°lisis por hora (Europa/USA)<br>
            ‚úÖ An√°lisis por sector<br>
            ‚úÖ Stocks personalizados<br>
            ‚úÖ Scanner autom√°tico (50 stocks)<br>
            ‚úÖ 6 criterios de b√∫squeda<br><br>
            <strong>Escribe la hora o elige una opci√≥n</strong>
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <textarea class="chat-input" id="userInput" placeholder="Escribe hora o ticker..." rows="1"></textarea>
        <button class="btn-send" onclick="sendMessage()">‚Üí</button>
      </div>
    </div>
    
    <div class="panel-right">
      <div class="panel-right-header">
        <h3>üìä Estado</h3>
        <p style="font-size: 11px; color: rgba(232,237,239,0.6);">En vivo</p>
      </div>
      <div class="panel-right-body">
        <div class="metric-card">
          <div class="metric-label">Sistema</div>
          <div class="metric-value">üü¢ Activo</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Backend</div>
          <div id="backendStatus"><span class="loading"></span> Conectando...</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">√öltima B√∫squeda</div>
          <div id="lastSearch" class="metric-value">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Oportunidades</div>
          <div id="oppCount" class="metric-value">0</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const API_URL = '/api';
    let currentMenu = 'europa';
    let currentSector = null;
    
    async function checkBackend() {
      try {
        const response = await fetch(API_URL + '/health', { mode: 'cors' });
        document.getElementById('backendStatus').innerHTML = response.ok ? 'üü¢ Activo' : 'üî¥ Offline';
      } catch (error) {
        document.getElementById('backendStatus').innerHTML = 'üî¥ Offline';
      }
    }
    
    function selectMenu(menu, element) {
      document.querySelectorAll('.menu-item:not(.submenu)').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      currentMenu = menu;
      currentSector = null;
      const msg = menu === 'europa' ? 'üåÖ <strong>Europa</strong><br>Escribe la hora' : 'üåô <strong>USA</strong><br>Escribe la hora';
      addMessage('system', msg);
    }
    
    async function selectSector(sectorKey) {
      if (!sectorKey) return;
      currentSector = sectorKey;
      currentMenu = null;
      document.querySelectorAll('.menu-item:not(.submenu)').forEach(el => el.classList.remove('active'));
      addMessage('system', '<span class="loading"></span> Cargando sector...');
      try {
        const response = await fetch(API_URL + `/sectores`, { mode: 'cors' });
        const data = await response.json();
        const sector = data.sectores.find(s => s.id === sectorKey);
        removeLastMessage();
        addMessage('system', `<strong>üéØ ${sector.nombre}</strong><br>${sector.descripcion}<br><br>Escribe la hora`);
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    function addMessage(type, content) {
      const chatMessages = document.getElementById('chatMessages');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      contentEl.innerHTML = content.replace(/\n/g, '<br>');
      messageEl.appendChild(contentEl);
      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      document.getElementById('lastSearch').innerHTML = new Date().toLocaleTimeString('es-ES');
    }
    
    function removeLastMessage() {
      const chatMessages = document.getElementById('chatMessages');
      const messages = chatMessages.querySelectorAll('.message');
      if (messages.length > 0) messages[messages.length - 1].remove();
    }
    
    async function sendMessage() {
      const text = document.getElementById('userInput').value.trim();
      if (!text) return;
      addMessage('user', text);
      document.getElementById('userInput').value = '';
      addMessage('system', '<span class="loading"></span> Analizando...');
      try {
        let url;
        if (currentSector) {
          url = API_URL + `/market/sector/${currentSector}/${text}`;
        } else if (currentMenu === 'europa') {
          url = API_URL + `/market/europe/${text}`;
        } else if (currentMenu === 'usa') {
          url = API_URL + `/market/usa/${text}`;
        } else {
          const ticker = text.match(/[A-Z]{1,4}/)?.[0];
          if (!ticker) {
            removeLastMessage();
            addMessage('system', 'üí° Escribe: Europa, USA, sector o ticker (AAPL)');
            return;
          }
          const response = await fetch(API_URL + '/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticker }),
            mode: 'cors'
          });
          const data = await response.json();
          removeLastMessage();
          if (!data.success) {
            addMessage('system', '‚ùå No encontrado');
            return;
          }
          let resultado = `<strong>${data.ticker}</strong> - $${data.precio}<br>${data.recomendacion}<br><strong>${data.accion}</strong><br><br>`;
          data.razones.forEach(r => resultado += `${r.icon} ${r.texto}<br>`);
          addMessage('system', resultado);
          document.getElementById('oppCount').innerHTML = data.score >= 60 ? '1' : '0';
          return;
        }
        const response = await fetch(url, { mode: 'cors' });
        const data = await response.json();
        removeLastMessage();
        if (!data.success) {
          addMessage('system', `‚ùå Error: ${data.error}`);
          return;
        }
        let resultado = `üìä <strong>${data.market || data.sector || 'An√°lisis'}</strong><br>‚úÖ ${data.total}<br><br>`;
        data.recommendations.forEach((rec, idx) => {
          let urgClass = rec.urgencia.includes('M√ÅXIMA') || rec.urgencia.includes('Alta') ? 'urgencia-alta' : rec.urgencia.includes('Media') ? 'urgencia-media' : 'urgencia-baja';
          resultado += `<div class="oportunidad"><strong>${idx+1}. ${rec.ticker}</strong> - ${rec.score}/150<br><span class="${urgClass}">${rec.urgencia}</span><br>${rec.accion}<br><small>Entry: $${rec.entrada} | Target: $${rec.target}</small></div>`;
        });
        addMessage('system', resultado);
        document.getElementById('oppCount').innerHTML = data.recommendations.length;
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    function openScannerCriteria() {
      const panel = document.getElementById('criteriaPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    async function scannerRapido() {
      addMessage('system', '<span class="loading"></span> üîç Escaneando 50 stocks...');
      try {
        const response = await fetch(API_URL + '/scanner/quick', { mode: 'cors' });
        const data = await response.json();
        removeLastMessage();
        if (!data.success) {
          addMessage('system', `‚ùå Error: ${data.error}`);
          return;
        }
        let resultado = `<strong>‚ö° TOP ${data.opportunities_found} OPORTUNIDADES</strong><br>Escaneados: ${data.total_scanned}<br><br>`;
        if (data.opportunities_found === 0) {
          resultado += 'Sin oportunidades claras';
          addMessage('system', resultado);
          return;
        }
        data.recommendations.forEach((rec, idx) => {
          let urgClass = rec.urgencia.includes('M√ÅXIMA') || rec.urgencia.includes('Alta') ? 'urgencia-alta' : rec.urgencia.includes('Media') ? 'urgencia-media' : 'urgencia-baja';
          resultado += `<div class="oportunidad"><strong>#${idx+1} ${rec.ticker}</strong><br><span class="${urgClass}">${rec.urgencia}</span><br>${rec.accion}<br><small>$${rec.entrada} ‚Üí $${rec.target}</small></div>`;
        });
        addMessage('system', resultado);
        document.getElementById('oppCount').innerHTML = data.opportunities_found;
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    async function scannerCriteria(criteria) {
      const names = { 'rsi_oversold': 'üìâ RSI < 30', 'high_volume': 'üìä Vol > 1.8x', 'reversal': 'üîÑ Reversiones', 'bullish_trend': 'üìà Tendencia Alcista', 'undervalued': 'üí∞ P/E < 20', 'momentum': 'üöÄ +3%' };
      addMessage('system', `<span class="loading"></span> Buscando ${names[criteria]}...`);
      try {
        const response = await fetch(API_URL + `/scanner/by-criteria/${criteria}`, { mode: 'cors' });
        const data = await response.json();
        removeLastMessage();
        if (!data.success) {
          addMessage('system', `‚ùå Error`);
          return;
        }
        let resultado = `<strong>${names[criteria]}</strong><br>Encontrados: ${data.matching}<br><br>`;
        if (data.matching === 0) {
          resultado += 'Sin resultados';
          addMessage('system', resultado);
          return;
        }
        data.recommendations.forEach((rec, idx) => {
          let urgClass = rec.urgencia.includes('M√ÅXIMA') || rec.urgencia.includes('Alta') ? 'urgencia-alta' : rec.urgencia.includes('Media') ? 'urgencia-media' : 'urgencia-baja';
          resultado += `<div class="oportunidad"><strong>${rec.ticker}</strong><br><span class="${urgClass}">${rec.urgencia}</span><br>${rec.score}/150<br><small>Entry: $${rec.entrada}</small></div>`;
        });
        addMessage('system', resultado);
        document.getElementById('oppCount').innerHTML = data.matching;
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error`);
      }
    }
    
    async function analizarCustom() {
      const stocks = document.getElementById('customStocks').value.trim();
      if (!stocks) {
        addMessage('system', '‚ùå Ingresa tickers');
        return;
      }
      addMessage('user', `Analizando: ${stocks}`);
      addMessage('system', '<span class="loading"></span> Analizando...');
      try {
        const response = await fetch(API_URL + `/market/custom/now`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stocks }),
          mode: 'cors'
        });
        const data = await response.json();
        removeLastMessage();
        if (!data.success) {
          addMessage('system', `‚ùå Error`);
          return;
        }
        let resultado = `üîß <strong>${data.total} stocks</strong><br><br>`;
        data.recommendations.forEach((rec, idx) => {
          let urgClass = rec.urgencia.includes('M√ÅXIMA') || rec.urgencia.includes('Alta') ? 'urgencia-alta' : rec.urgencia.includes('Media') ? 'urgencia-media' : 'urgencia-baja';
          resultado += `<div class="oportunidad"><strong>${rec.ticker}</strong><br><span class="${urgClass}">${rec.urgencia}</span><br>${rec.accion}<br><small>$${rec.entrada}</small></div>`;
        });
        addMessage('system', resultado);
        document.getElementById('oppCount').innerHTML = data.recommendations.length;
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error`);
      }
    }
    
    document.getElementById('userInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    checkBackend();
    setInterval(checkBackend, 10000);
    selectMenu('europa', document.querySelector('.menu-item.active'));
  </script>
</body>
</html>
