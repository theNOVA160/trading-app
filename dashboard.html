<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard - Datos Reales</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2180A0;
      --secondary: #1a2332;
      --text: #e8edef;
      --success: #32b898;
      --warning: #a84b2f;
      --error: #c01530;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--secondary);
      color: var(--text);
      overflow: hidden;
    }
    
    .container {
      display: flex;
      height: 100vh;
      gap: 12px;
      padding: 12px;
    }
    
    /* ===== LEFT PANEL ===== */
    .panel-left {
      width: 280px;
      background: #243447;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .panel-header {
      padding: 16px;
      background: rgba(33, 128, 160, 0.15);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-header h2 { font-size: 16px; margin-bottom: 4px; }
    .panel-header p { font-size: 11px; color: rgba(232, 237, 239, 0.6); }
    
    .menu-section {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .menu-section h3 {
      font-size: 10px;
      text-transform: uppercase;
      color: rgba(232, 237, 239, 0.5);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .menu-item {
      padding: 12px;
      margin-bottom: 6px;
      background: rgba(255,255,255,0.05);
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .menu-item:hover {
      background: rgba(33, 128, 160, 0.2);
      border-color: var(--primary);
    }
    
    .menu-item.active {
      background: var(--primary);
      border-color: var(--primary);
      font-weight: 500;
    }
    
    .menu-item.submenu {
      padding-left: 24px;
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .sector-label {
      font-size: 10px;
      padding: 6px 12px;
      color: rgba(232, 237, 239, 0.6);
      margin: 8px 0 4px 0;
    }
    
    .select-control {
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      margin: 8px 0;
      width: 100%;
    }
    
    .select-control:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }
    
    /* ===== CENTER PANEL ===== */
    .panel-center {
      flex: 1;
      background: #243447;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      display: flex;
      gap: 8px;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user { justify-content: flex-end; }
    .message.system { justify-content: flex-start; }
    
    .message-content {
      max-width: 70%;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .message.user .message-content {
      background: var(--primary);
      color: white;
    }
    
    .message.system .message-content {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .sector-info {
      background: rgba(50, 184, 198, 0.1);
      border-left: 3px solid var(--primary);
      padding: 12px;
      margin: 8px 0;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .chat-input-area {
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 14px;
      resize: none;
      max-height: 80px;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }
    
    .btn-send {
      padding: 10px 16px;
      background: var(--primary);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }
    
    .btn-send:hover { background: #1a6a7f; }
    .btn-send:active { transform: scale(0.95); }
    
    /* ===== RIGHT PANEL ===== */
    .panel-right {
      width: 300px;
      background: #243447;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .panel-right-header {
      padding: 16px;
      background: rgba(50, 184, 198, 0.1);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .panel-right-header h3 { font-size: 14px; margin-bottom: 4px; }
    
    .panel-right-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .metric-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(232, 237, 239, 0.6);
      margin-bottom: 4px;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT PANEL -->
    <div class="panel-left">
      <div class="panel-header">
        <h2>üìä Trading Dashboard</h2>
        <p>Datos Reales en Vivo v2.0</p>
      </div>
      
      <div class="menu-section">
        <h3>Mercados por Hora</h3>
        <div class="menu-item active" onclick="selectMenu('europa', this)">
          <span>üåÖ</span> Europa (8 AM)
        </div>
        <div class="menu-item" onclick="selectMenu('usa', this)">
          <span>üåô</span> USA (2:30 PM)
        </div>
      </div>
      
      <div class="menu-section">
        <h3>An√°lisis por Sector</h3>
        <select class="select-control" id="sectorSelect" onchange="selectSector(this.value)">
          <option value="">Seleccionar sector...</option>
          <option value="tech">üíª Tecnolog√≠a</option>
          <option value="banks">üè¶ Banca</option>
          <option value="energy">‚ö° Energ√≠a</option>
          <option value="pharma">üíä Farmac√©utica</option>
          <option value="retail">üõí Retail</option>
          <option value="industrial">üè≠ Industrial</option>
        </select>
        <div id="sectorInfo" style="display: none;" class="sector-info"></div>
      </div>
      
      <div class="menu-section">
        <h3>An√°lisis Custom</h3>
        <input type="text" id="customStocks" class="select-control" placeholder="Ej: AAPL,MSFT,GOOGL" />
        <button onclick="analizarCustom()" style="width: 100%; padding: 8px; margin-top: 8px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer;">
          üîç Analizar
        </button>
      </div>
      
      <div class="menu-section">
        <h3>Sistema</h3>
        <div class="menu-item" onclick="selectMenu('ayuda', this)">
          <span>‚ùì</span> Ayuda
        </div>
      </div>
    </div>
    
    <!-- CENTER PANEL -->
    <div class="panel-center">
      <div class="chat-messages" id="chatMessages">
        <div class="message system">
          <div class="message-content">
            üëã <strong>¬°Bienvenido Trading Dashboard v2!</strong><br><br>
            <strong>Nuevas opciones:</strong><br>
            ‚Ä¢ üìà An√°lisis por hora (Europa/USA)<br>
            ‚Ä¢ üéØ An√°lisis por sector (Tech, Banca, etc)<br>
            ‚Ä¢ üîß Stocks personalizados<br>
            ‚Ä¢ üìä Datos reales en vivo<br>
            ‚Ä¢ üí° Reasoning autom√°tico<br><br>
            <strong>¬øPor qu√© elijo esos stocks?</strong><br>
            Cada opci√≥n analiza empresas l√≠deres en su sector con alto volumen y datos confiables.
          </div>
        </div>
      </div>
      
      <div class="chat-input-area">
        <textarea class="chat-input" id="userInput" placeholder="Escribe pregunta o ticker..." rows="1"></textarea>
        <button class="btn-send" onclick="sendMessage()">‚Üí</button>
      </div>
    </div>
    
    <!-- RIGHT PANEL -->
    <div class="panel-right">
      <div class="panel-right-header">
        <h3>üìä M√©tricas</h3>
        <p style="font-size: 11px; color: rgba(232,237,239,0.6);">En tiempo real</p>
      </div>
      
      <div class="panel-right-body" id="metricsPanel">
        <div class="metric-card">
          <div class="metric-label">Estado del Sistema</div>
          <div class="metric-value">üü¢ Conectado</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Backend (Node.js)</div>
          <div id="backendStatus">
            <span class="loading"></span> Verificando...
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Versi√≥n</div>
          <div class="metric-value">v2.0</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">√öltima Actualizaci√≥n</div>
          <div id="lastUpdate" class="metric-value">--</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const userInput = document.getElementById('userInput');
    const chatMessages = document.getElementById('chatMessages');
    const backendStatus = document.getElementById('backendStatus');
    const API_URL = '/api';
    let currentMenu = 'europa';
    let currentSector = null;
    
    // ===== VERIFICAR BACKEND =====
    async function checkBackend() {
      try {
        const response = await fetch(API_URL + '/health', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        if (response.ok) {
          backendStatus.innerHTML = 'üü¢ Activo';
        } else {
          backendStatus.innerHTML = 'üî¥ Offline';
        }
      } catch (error) {
        backendStatus.innerHTML = 'üî¥ Offline';
      }
    }
    
    // ===== SELECCIONAR MEN√ö =====
    function selectMenu(menu, element) {
      if (element) {
        document.querySelectorAll('.menu-item:not(.submenu)').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
      }
      currentMenu = menu;
      currentSector = null;
      
      const mensajes = {
        europa: 'üåÖ <strong>An√°lisis Europa - 8 AM</strong><br><br><strong>¬øPor qu√© estos stocks?</strong><br>SAP, ASML, LVMH, SIEMENS, UNILEVER, HSBC, SHELL, SANOFI<br><br>Empresas l√≠deres europeas con:<br>‚úì Alto volumen de negociaci√≥n<br>‚úì Datos hist√≥ricos confiables<br>‚úì Diversificaci√≥n sectorial<br>‚úì Presencia global<br><br>Escribe la hora (ej: "8") para actualizar an√°lisis.',
        usa: 'üåô <strong>An√°lisis USA - 2:30 PM</strong><br><br><strong>¬øPor qu√© estos stocks?</strong><br>AAPL, MSFT, GOOGL, AMZN, NVDA, TSLA, META, NFLX<br><br>Megacaps tecnol√≥gicas con:<br>‚úì Capitalizaci√≥n > $1 trili√≥n<br>‚úì Volumen extremadamente alto<br>‚úì L√≠deres en IA e innovaci√≥n<br>‚úì Datos de Yahoo Finance verificados<br><br>Escribe la hora (ej: "14") para actualizar.',
        ayuda: '‚ùì <strong>Gu√≠a de Uso</strong><br><br><strong>1. Mercados por Hora:</strong><br>An√°lisis autom√°tico de 8 stocks cada uno. Datos en vivo de Yahoo Finance.<br><br><strong>2. An√°lisis por Sector:</strong><br>Elige un sector y ver√°s empresas l√≠deres de ese √°rea.<br><br><strong>3. Custom:</strong><br>Escribe tickers separados por comas (AAPL,TSLA,MSFT)<br><br><strong>Score 0-150:</strong><br>0-65: Esperar | 65-90: Especulativo | 90-110: Moderado | 110+: Agresivo'
      };
      
      addMessage('system', mensajes[menu] || 'Opci√≥n seleccionada');
    }
    
    // ===== SELECCIONAR SECTOR =====
    async function selectSector(sectorKey) {
      if (!sectorKey) return;
      
      currentSector = sectorKey;
      currentMenu = null;
      
      document.querySelectorAll('.menu-item:not(.submenu)').forEach(el => el.classList.remove('active'));
      
      addMessage('system', '<span class="loading"></span> Cargando sector...');
      
      try {
        const response = await fetch(API_URL + `/sectores`, { mode: 'cors' });
        const data = await response.json();
        const sector = data.sectores.find(s => s.id === sectorKey);
        
        removeLastMessage();
        addMessage('system', `<strong>üéØ Sector: ${sector.nombre}</strong><br><br>${sector.descripcion}<br><br>Stocks: ${sector.stocks} empresas l√≠deres<br><br>Escribe hora (ej: "9") para analizar.`);
        
        document.getElementById('sectorInfo').innerHTML = `<strong>${sector.nombre}</strong><br>${sector.descripcion}`;
        document.getElementById('sectorInfo').style.display = 'block';
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    // ===== AGREGAR MENSAJE =====
    function addMessage(type, content) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      contentEl.innerHTML = content.replace(/\n/g, '<br>');
      
      messageEl.appendChild(contentEl);
      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      document.getElementById('lastUpdate').innerHTML = new Date().toLocaleTimeString('es-ES');
    }
    
    // ===== REMOVER √öLTIMO MENSAJE =====
    function removeLastMessage() {
      const messages = chatMessages.querySelectorAll('.message');
      if (messages.length > 0) {
        messages[messages.length - 1].remove();
      }
    }
    
    // ===== ENVIAR MENSAJE =====
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      
      addMessage('user', text);
      userInput.value = '';
      addMessage('system', '<span class="loading"></span> Analizando...');
      
      try {
        if (currentSector) {
          await analizarSector(text, currentSector);
        } else if (currentMenu === 'europa') {
          await analizarMercado(text, 'europe');
        } else if (currentMenu === 'usa') {
          await analizarMercado(text, 'usa');
        } else {
          await procesarTickerDirecto(text);
        }
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    // ===== ANALIZAR SECTOR =====
    async function analizarSector(hora, sector) {
      try {
        const response = await fetch(API_URL + `/market/sector/${sector}/${hora}`, { mode: 'cors' });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) {
          removeLastMessage();
          addMessage('system', `‚ùå Error: ${data.error}`);
          return;
        }
        
        removeLastMessage();
        
        let resultado = `üìä <strong>${data.sectorInfo.descripcion}</strong><br><br>`;
        resultado += `‚úÖ ${data.total} empresas analizadas<br>`;
        resultado += `üéØ Top recomendaciones:<br><br>`;
        
        data.recommendations.slice(0, 5).forEach((rec, idx) => {
          resultado += `${idx+1}. <strong>${rec.ticker}</strong> - Score ${rec.score}/150<br>`;
          resultado += `   ${rec.recomendacion}<br>`;
          resultado += `   Entrada: $${rec.entrada} | Target: $${rec.target} | Stop: $${rec.stopLoss}<br><br>`;
        });
        
        addMessage('system', resultado);
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error al obtener datos: ${error.message}`);
      }
    }
    
    // ===== ANALIZAR MERCADO =====
    async function analizarMercado(hora, market) {
      try {
        const response = await fetch(API_URL + `/market/${market}/${hora}`, { mode: 'cors' });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) {
          removeLastMessage();
          addMessage('system', `‚ùå Error: ${data.error}`);
          return;
        }
        
        removeLastMessage();
        
        let resultado = `üìä <strong>An√°lisis ${market === 'europe' ? 'Europeo' : 'USA'} - ${data.hour}</strong><br><br>`;
        resultado += `‚úÖ ${data.total} activos analizados<br>`;
        resultado += `üéØ Top recomendaciones:<br><br>`;
        
        data.recommendations.slice(0, 5).forEach((rec, idx) => {
          resultado += `${idx+1}. <strong>${rec.ticker}</strong> - Score ${rec.score}/150<br>`;
          resultado += `   ${rec.recomendacion}<br>`;
          resultado += `   Entrada: $${rec.entrada} | Target: $${rec.target} | Stop: $${rec.stopLoss}<br><br>`;
        });
        
        addMessage('system', resultado);
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error al obtener datos: ${error.message}`);
      }
    }
    
    // ===== ANALIZAR CUSTOM =====
    async function analizarCustom() {
      const stocks = document.getElementById('customStocks').value.trim();
      if (!stocks) {
        addMessage('system', '‚ùå Ingresa al menos un ticker');
        return;
      }
      
      addMessage('user', `Analizando: ${stocks}`);
      addMessage('system', '<span class="loading"></span> Cargando datos personalizados...');
      
      try {
        const response = await fetch(API_URL + `/market/custom/now`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stocks: stocks }),
          mode: 'cors'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) {
          removeLastMessage();
          addMessage('system', `‚ùå Error: ${data.error}`);
          return;
        }
        
        removeLastMessage();
        
        let resultado = `üîß <strong>An√°lisis Custom</strong><br><br>`;
        resultado += `‚úÖ ${data.total} stocks analizados<br><br>`;
        
        data.recommendations.forEach((rec, idx) => {
          resultado += `${idx+1}. <strong>${rec.ticker}</strong> - Score ${rec.score}/150<br>`;
          resultado += `   ${rec.recomendacion}<br>`;
          resultado += `   Entrada: $${rec.entrada} | Target: $${rec.target} | Stop: $${rec.stopLoss}<br><br>`;
        });
        
        addMessage('system', resultado);
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    // ===== PROCESAR TICKER DIRECTO =====
    async function procesarTickerDirecto(text) {
      const tickerMatch = text.match(/[A-Z]{1,4}/);
      if (!tickerMatch) {
        removeLastMessage();
        addMessage('system', 'üí° Usa: Europa, USA, sector, o ticker (AAPL, MSFT, etc)');
        return;
      }
      
      try {
        const response = await fetch(API_URL + '/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker: tickerMatch[0] }),
          mode: 'cors'
        });
        
        const data = await response.json();
        
        if (!data.success) {
          removeLastMessage();
          addMessage('system', `‚ùå Stock no encontrado`);
          return;
        }
        
        removeLastMessage();
        
        let resultado = `üìä <strong>${data.ticker}</strong><br><br>`;
        resultado += `Precio: $${data.precio.toFixed(2)} (${data.cambio > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'} ${data.cambio.toFixed(2)}%)<br>`;
        resultado += `Score: ${data.score}/150 ${data.recomendacion}<br>`;
        resultado += `Confianza: ${data.confianza}%<br><br>`;
        resultado += `<strong>Setup:</strong><br>`;
        resultado += `Entrada: $${data.entrada}<br>`;
        resultado += `Target 1: $${data.target1} | Target 2: $${data.target2}<br>`;
        resultado += `Stop Loss: $${data.stopLoss}<br><br>`;
        resultado += `<strong>Reasoning:</strong><br>`;
        data.detalles.forEach(d => {
          resultado += `${d.puntos > 0 ? '‚úì' : '‚úó'} ${d.factor}: ${d.puntos > 0 ? '+' : ''}${d.puntos}<br>`;
        });
        
        addMessage('system', resultado);
      } catch (error) {
        removeLastMessage();
        addMessage('system', `‚ùå Error: ${error.message}`);
      }
    }
    
    // ===== INIT =====
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    checkBackend();
    setInterval(checkBackend, 10000);
    selectMenu('europa', document.querySelector('.menu-item.active'));
  </script>
</body>
</html>
